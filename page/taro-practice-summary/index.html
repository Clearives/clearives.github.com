<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用Taro开发小程序遇到的问题与解决方案 | Clearives</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="前端博客clearives.cc是基于vuepress搭建的前端技术分享博客，有js、node、react、vue等前端技术分享">
    <meta name="keywords" content="前端开发，前端技术，html，js，JavaScript，node，react，vue，前端博客，clearives，vuepress">
    <link rel="preload" href="/assets/css/0.styles.ea47b85f.css" as="style"><link rel="preload" href="/assets/js/app.8f6fd0c9.js" as="script"><link rel="preload" href="/assets/js/2.b90ad0ea.js" as="script"><link rel="preload" href="/assets/js/18.916a88b7.js" as="script"><link rel="preload" href="/assets/js/3.08c50603.js" as="script"><link rel="prefetch" href="/assets/js/10.a22d8dee.js"><link rel="prefetch" href="/assets/js/11.63bfcf77.js"><link rel="prefetch" href="/assets/js/12.0e23309a.js"><link rel="prefetch" href="/assets/js/13.756aa44d.js"><link rel="prefetch" href="/assets/js/14.62f7caac.js"><link rel="prefetch" href="/assets/js/15.d862887f.js"><link rel="prefetch" href="/assets/js/16.3e4680c2.js"><link rel="prefetch" href="/assets/js/17.5fb301ba.js"><link rel="prefetch" href="/assets/js/19.25be6734.js"><link rel="prefetch" href="/assets/js/20.52298525.js"><link rel="prefetch" href="/assets/js/21.4d2eba85.js"><link rel="prefetch" href="/assets/js/22.634cb17e.js"><link rel="prefetch" href="/assets/js/23.837e46ba.js"><link rel="prefetch" href="/assets/js/24.dd6aac08.js"><link rel="prefetch" href="/assets/js/25.b08c0c36.js"><link rel="prefetch" href="/assets/js/26.93b109dc.js"><link rel="prefetch" href="/assets/js/27.0b1aa968.js"><link rel="prefetch" href="/assets/js/28.0197f818.js"><link rel="prefetch" href="/assets/js/29.79a78bf3.js"><link rel="prefetch" href="/assets/js/30.1b9ca2e7.js"><link rel="prefetch" href="/assets/js/31.b684d314.js"><link rel="prefetch" href="/assets/js/32.6ab1ffb2.js"><link rel="prefetch" href="/assets/js/4.2d03c6f2.js"><link rel="prefetch" href="/assets/js/5.0b9e59f3.js"><link rel="prefetch" href="/assets/js/6.da510395.js"><link rel="prefetch" href="/assets/js/7.fd0ae54b.js"><link rel="prefetch" href="/assets/js/8.3a34e5f9.js"><link rel="prefetch" href="/assets/js/9.b4a289c7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ea47b85f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Clearives</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link">
  前端知识
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Nodejs
</a></div><div class="nav-item"><a href="/package/" class="nav-link">
  前端框架
</a></div><div class="nav-item"><a href="/daily/record/" class="nav-link">
  日记本
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link">
  前端知识
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Nodejs
</a></div><div class="nav-item"><a href="/package/" class="nav-link">
  前端框架
</a></div><div class="nav-item"><a href="/daily/record/" class="nav-link">
  日记本
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/frontend/" class="sidebar-link">前端</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Javascript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/page/2017-06-06-qiniu-upload/" class="sidebar-link">vue使用七牛上传</a></li><li><a href="/page/2017-06-23-livereload/" class="sidebar-link">Live​Reload实时刷新网页</a></li><li><a href="/page/array-and-object/" class="sidebar-link">如何区分是对象还是数组</a></li><li><a href="/page/array-clone/" class="sidebar-link">数组的复制</a></li><li><a href="/page/browser-window-open-intercept/" class="sidebar-link">浏览器拦截弹出的新窗口问题</a></li><li><a href="/page/es6-learn-summary/" class="sidebar-link">ES6学习笔记</a></li><li><a href="/page/js-traversing/" class="sidebar-link">JS遍历</a></li><li><a href="/page/loops_and_iteration/" class="sidebar-link">循环与迭代笔记</a></li><li><a href="/page/taro-practice-summary/" aria-current="page" class="active sidebar-link">使用Taro开发小程序遇到的问题与解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/page/taro-practice-summary/#taro的引入" class="sidebar-link">Taro的引入</a></li><li class="sidebar-sub-header"><a href="/page/taro-practice-summary/#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header"><a href="/page/taro-practice-summary/#后续改进优化" class="sidebar-link">后续改进优化</a></li><li class="sidebar-sub-header"><a href="/page/taro-practice-summary/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/page/weapp-save-base64/" class="sidebar-link">微信小程序保存base64图片到本地</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="taro的引入"><a href="#taro的引入" class="header-anchor">#</a> Taro的引入</h2> <p>之前公司在开发保险项目的时候，我们开发小程序引入了Taro，那会还是1.x的版本，也没有hooks，为什么会用这个框架呢，主要是目前前端主要是技术栈是react，各位成员开发起来也会比较顺畅，由于保险的项目就做了一个版本，并且功能不多，所以第一次使用这个框架的时候，并没有太多的深入，只是实现了需求。最近这2个月，团居客的业务，启动了2个小程序，一个是工具类的，一个是业务类的，这一次，我们引入了Taro2.x，并且页面组件全部采用hooks来写，下面来总结一下这个过程里遇到的一些问题。</p> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <h3 id="自定义头部导航返回键的问题"><a href="#自定义头部导航返回键的问题" class="header-anchor">#</a> 自定义头部导航返回键的问题</h3> <p>当然，如果我们不使用自定义头部，是没有问题的，因为系统以及帮我们设定好了，什么时候是返回，什么时候是回到主页，我们的场景是头部自定义，除了三个Tab栏（当然也是自定义的，只是没有返回键而已），其他都是带返回键和主页按键的，如下图：
<img src="https://cdn.nlark.com/yuque/0/2020/png/146269/1597312300382-776130b8-3792-4e03-b609-703c25925c87.png#align=left&amp;display=inline&amp;height=158&amp;margin=%5Bobject%20Object%5D&amp;originHeight=158&amp;originWidth=744&amp;size=0&amp;status=done&amp;style=none&amp;width=744" alt="">
这样子会有一个问题，就是当我们从别人分享出来的页面打开，返回键就不能正常工作了，因为在小程序里，这是第一个打开的页面，不存在上级页面，因此我们在这个时候把返回键隐藏。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>back<span class="token punctuation">,</span> setBack<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Taro<span class="token punctuation">.</span><span class="token function">getCurrentPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 判断首次激活小程序的页面</span>
    <span class="token function">setBack</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">setBack</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="生命周期问题"><a href="#生命周期问题" class="header-anchor">#</a> 生命周期问题</h3> <p>因为我们全部使用的是hooks来编写代码，所以我们不说传统class组件的实现方式</p> <ul><li>useState
当我们单个state使用的时候就是按照语法来使用即可，但是当state是一个对象的时候，我们要知道与class 组件中setState 方法不同，useState不会自动合并更新对象。你可以用函数式的setState结合展开运算符来达到合并更新对象的效果。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/pages/house/rentHouse/detail/index.jsx</span>
<span class="token keyword">const</span> <span class="token function-variable function">toggle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>prevState<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">{</span> showCommunityOverviewAll<span class="token operator">:</span> <span class="token operator">!</span>prevState<span class="token punctuation">.</span>showCommunityOverviewAll <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>useEffect
该hook接收一个包含命令式、且可能有副作用代码的函数，其实在react里，我们很多生命周期都可以用这个hooks来模拟，我们知道，每次setState的时候，会重新调用整个函数，那么useEffect就会被执行，当然这个是可控的，也就是它的第二个参数依赖数组，数组为空，里面的函数只会执行一次，相当于componentDidMount，我们可以在数组里传我们需要控制的state，从而控制函数的执行，包括里面也可以传props的值，相当于实现componentWillReceiveProps的效果。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/pages/groupHouse/groupTime.jsx</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">timeHandler</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>bidCountdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>useDidShow
这个相当于小程序里面的onShow,也就是页面显示时触发，大部分页面，尤其是内容页，我们请求数据都可以在这个里面完成，但是，在列表页面，我们发现数据频繁初始化，因为请求了数据，然后页面重置了，导致想看到的东西确看不到，要重新操作一遍，才能看到，所以我们在列表页做的处理是，把请求全部放到useEffect里去，然后加入下拉刷新，也就是初始化的时候请求一次，想更新数据可以下拉请求，非特殊情况，不在每当显示页面的时候触发接口去请求数据。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/pages/groupHouse/index.jsx</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">queryListData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>paging<span class="token punctuation">,</span>
    sortType<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>useShareAppMessage
该hook等同于onShareAppMessage页面生命周期钩子，也就是分享配置，这里我们还涉及到一个就是按钮分享，按钮分享有一个问题，就是分享配置一定要写在页面函数里，不能写在组件里面。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/pages/personal/group/groupItem.jsx</span>
<span class="token operator">&lt;</span>Button className<span class="token operator">=</span><span class="token string">'more'</span> open<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">'share'</span> data<span class="token operator">-</span>info<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>ele<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
  邀请好友
<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>

<span class="token comment">// Reference src/pages/personal/group/index.jsx</span>
<span class="token function">useShareAppMessage</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>from <span class="token operator">===</span> <span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 来自页面内转发按钮</span>
    <span class="token keyword">let</span> ele <span class="token operator">=</span> res<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>info<span class="token punctuation">.</span>ele<span class="token punctuation">;</span>
    <span class="token keyword">let</span> _path<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span>houseSource <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/pages/house/houDetail/groupHouDetail?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ele<span class="token punctuation">.</span>houseId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span>houseSource <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/pages/house/houDetail/newHouDetail?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ele<span class="token punctuation">.</span>houseId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      title<span class="token operator">:</span> ele<span class="token punctuation">.</span>houseTitle<span class="token punctuation">,</span>
      path<span class="token operator">:</span> _path<span class="token punctuation">,</span>
      imageUrl<span class="token operator">:</span> ele<span class="token punctuation">.</span>picAddr
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      title<span class="token operator">:</span> <span class="token string">&quot;团购房源&quot;</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> <span class="token string">&quot;/pages/groupHouse/index&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>这里面我们Button使用到了2个特殊的参数，一个是open-type='share'，这个参数主要是让按钮可以实现转发功能，还有一个就是data-info，这个主要是动态传参，因为我们邀请分享的时候是分享出去对应列表的当个房源，所以我们必须动态传递参数到分享配置，然后在页面useShareAppMessage里面接受，通过res.target.dataset.info，这样我们就可以实现动态分享，当然这个时候页面的分享按钮我们必须屏蔽，使用Taro.hideShareMenu()。</p> <ul><li>其他的生命周期正常使用即可，目前使用情况一般，没遇到以下特殊的问题</li></ul> <h3 id="代码超过2m，分包"><a href="#代码超过2m，分包" class="header-anchor">#</a> 代码超过2M，分包</h3> <p>小程序的机制，未使用分包，包大小限制2M，使用分包，总包大小限制16M，单个包限制2M，所以我们采取了分包加载。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/app.jsx</span>
<span class="token comment">// 注意，分包必须在同一个文件夹，非包内文件不能放在文件夹内，不然匹配路径出错</span>
subPackages<span class="token operator">:</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pages/personal/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pages/house/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="tab切换的时候列表数据问题"><a href="#tab切换的时候列表数据问题" class="header-anchor">#</a> tab切换的时候列表数据问题</h3> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/146269/1597312300732-e5cadf01-244e-4da0-999e-d88fa0f7b07a.png#align=left&amp;display=inline&amp;height=526&amp;margin=%5Bobject%20Object%5D&amp;originHeight=526&amp;originWidth=748&amp;size=0&amp;status=done&amp;style=none&amp;width=748" alt="图片">
首页这个地方，有三个tab，而且三个tab下面都是请求列表数据，切换的时候会出现数据组装错误，导致渲染出的列表数据有问题，我们必须在点击的时候把列表数据清除，然后再去请求数据。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/pages/homePage/index.jsx</span>
<span class="token keyword">const</span> <span class="token function-variable function">cbTabHotHandle</span> <span class="token operator">=</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value <span class="token operator">!==</span> hotSelValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setHotSelList</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setHotSelList</span><span class="token punctuation">(</span>homeData<span class="token punctuation">.</span>houseInfoList<span class="token punctuation">[</span><span class="token function">Number</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>newHouseVOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setHotSelValue</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="小程序与h5交互"><a href="#小程序与h5交互" class="header-anchor">#</a> 小程序与H5交互</h3> <p>小程序里面的旅居模块、协议、关于我们等都是采用H5的方式来开发的，因为是现成的，但是我们小程序里面接入H5要注意一些东西：</p> <ul><li>webview只能传入一个地址，并且页面会铺面整个界面</li> <li>webview的链接地址最好转码解码处理一下</li> <li>H5内部与小程序交互（目前用到的就是跳转），H5里面引入wxsdk，然后使用它对应的方法即可。</li> <li>webview内H5调试也可以在模拟器上右键调试进入H5页面的调试</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webview</span>
<span class="token keyword">function</span> <span class="token function">TjkWebView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span>params<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>
		<span class="token operator">&lt;</span>WebView src<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用 </span>
Taro<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/pages/webview/index?url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>
      <span class="token string">&quot;https://www.tuanjuker.com/tjk/wap/app/aboutUs.html&quot;</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="登录拦截"><a href="#登录拦截" class="header-anchor">#</a> 登录拦截</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/utils/request.js</span>
<span class="token comment">// 这里还存在一个，就是登录成功回到之前页面，刷不刷新的问题，这个后续想方法优化，目前都是特殊处理</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">10020026</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token string">'noNeedLog'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// noNeedLog为了处理一些虽然未登录但不需要跳转的场景</span>
            Taro<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                url<span class="token operator">:</span> <span class="token string">'/pages/login/index'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        Taro<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'/pages/login/index'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="样式问题"><a href="#样式问题" class="header-anchor">#</a> 样式问题</h3> <ul><li>伪类使用打包会出现问题，具体啥原因不知道，反正少用不用就行，用标签替代</li> <li>页面底部有固定按钮需留出间距，使用margin在ios上无效，需要使用padding</li> <li>组件内样式必须在组件内引入，在外层引入无效</li> <li><s>多行文本超过显示省略号样无效，网上又说可以，试了几次都不行，单行省略号是正常的（已解决2020-08-13 17:49:56）</s></li></ul> <p><strong>解决方案参考</strong>：<a href="https://stackoverflow.com/questions/46152850/webkit-box-orient-styling-disappears-from-styling" target="" rel="noopener noreferrer">https://stackoverflow.com/questions/46152850/webkit-box-orient-styling-disappears-from-styling</a></p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token property">text-overflow</span><span class="token punctuation">:</span> ellipsis<span class="token punctuation">;</span>
<span class="token property">display</span><span class="token punctuation">:</span> -webkit-box<span class="token punctuation">;</span>
<span class="token comment">/* autoprefixer: ignore next */</span>
<span class="token property">-webkit-box-orient</span><span class="token punctuation">:</span> vertical<span class="token punctuation">;</span>
<span class="token property">-webkit-line-clamp</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
<span class="token property">white-space</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>多用flex，少用浮动</li></ul> <h3 id="其他问题"><a href="#其他问题" class="header-anchor">#</a> 其他问题</h3> <ul><li>组件索引，key不要用index</li> <li>百度统计接入，最新版（V1.9.18）的小程序统计sdk接入，程序没有任何统计请求，V1.9.1是正常的，为此我们把统计换成了阿拉丁</li> <li>Taro.login()不能和按钮点击获取手机号同时除非，或出现session失效的问题，必须前置执行即可</li> <li>base64位图片保存到相册不能直接跟保存png一样</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Reference src/pages/personal/invite/index.jsx</span>
<span class="token keyword">var</span> fileSystemManager <span class="token operator">=</span> Taro<span class="token punctuation">.</span><span class="token function">getFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> number <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fileSystemManager<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  filePath<span class="token operator">:</span> Taro<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USER_DATA_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/pic&quot;</span> <span class="token operator">+</span> number <span class="token operator">+</span> <span class="token string">&quot;.png&quot;</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> img<span class="token punctuation">,</span>
  encoding<span class="token operator">:</span> <span class="token string">&quot;base64&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Taro<span class="token punctuation">.</span><span class="token function">saveImageToPhotosAlbum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 后续代码隐藏</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>后台小程序码生成，参数只能通过scene传递，而且小程序需上线才能调试，这样页面代码可能需要做一些特殊处理，还有一种方式就是通过中转页来实现，后续实现之后再补上具体改动</li></ul> <h2 id="后续改进优化"><a href="#后续改进优化" class="header-anchor">#</a> 后续改进优化</h2> <ul><li>代码结构优化</li> <li>数据流优化</li> <li>H5赋能小程序，尝试接入较为复杂H5，看效果如何？</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>以上是这两个月开发小程序过程中遇到的一些问题，大部分有好的解决方案，还有一些退而求次，解决了， 希望后续可以优化下里面的代码。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">3/8/2021, 2:04:53 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/page/loops_and_iteration/" class="prev">
        循环与迭代笔记
      </a></span> <span class="next"><a href="/page/weapp-save-base64/">
        微信小程序保存base64图片到本地
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div></div><!----></div></div>
    <script src="/assets/js/app.8f6fd0c9.js" defer></script><script src="/assets/js/2.b90ad0ea.js" defer></script><script src="/assets/js/18.916a88b7.js" defer></script><script src="/assets/js/3.08c50603.js" defer></script>
  </body>
</html>
